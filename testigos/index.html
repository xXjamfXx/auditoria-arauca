<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reporte Electoral - Arauca 2026</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="L102 Testigos">
    <link rel="apple-touch-icon" href="https://fybolbgnxoertkocmmza.supabase.co/storage/v1/object/public/recursos/l102-remo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { position: relative; z-index: 10; overflow-x: hidden; }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans min-h-screen">

    <div class="fixed inset-0 z-[-1] bg-cover bg-center bg-no-repeat opacity-[0.05] pointer-events-none" 
         style="background-image: url('https://fybolbgnxoertkocmmza.supabase.co/storage/v1/object/public/recursos/fondo_candidato.JPG'); filter: grayscale(10%); mix-blend-mode: multiply;">
    </div>

    <div class="max-w-md mx-auto bg-white/95 backdrop-blur-sm p-6 rounded-3xl shadow-xl border border-gray-200 relative z-10">
        
        <div class="text-center mb-6"><img src="https://fybolbgnxoertkocmmza.supabase.co/storage/v1/object/public/recursos/l102-remo.png"  
         alt="Logo L102" 
         class="h-24 w-auto object-contain drop-shadow-md inline-block">
         <img src="https://fybolbgnxoertkocmmza.supabase.co/storage/v1/object/public/recursos/L102-NUMERO.png"
         alt="Numero 102" 
         class="h-24 w-auto object-contain drop-shadow-md inline-block">
            <h1 class="text-2xl font-black text-blue-900 leading-tight">Reporte Testigos</h1>
        </div>

        <div id="pantalla-config">
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-2">Municipio</label>
                    <select id="select-municipio" class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-lg font-bold outline-none focus:border-blue-500 transition-all">
                        <option value="">Seleccionar...</option>
                        <option value="1">ARAUCA</option>
                        <option value="2">ARAUQUITA</option>
                        <option value="3">CRAVO NORTE</option>
                        <option value="4">FORTUL</option>
                        <option value="5">PUERTO ROND√ìN</option>
                        <option value="6">SARAVENA</option>
                        <option value="7">TAME</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-2">Puesto de Votaci√≥n</label>
                    <select id="select-puesto" class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-lg font-bold outline-none" disabled>
                        <option value="">-- Elija municipio --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 ml-2">Mesa N√∫mero</label>
                    <input type="number" id="input-mesa" autocomplete="off" class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-2xl font-black text-blue-900 outline-none" placeholder="00">
                </div>

                <button id="btn-fijar" class="w-full bg-blue-900 text-white font-black py-4 rounded-2xl shadow-lg uppercase tracking-widest mt-4">
                    Fijar Ubicaci√≥n
                </button>
            </div>
        </div>

        <div id="pantalla-reporte" class="hidden space-y-6">
            <div class="bg-blue-900 p-5 rounded-2xl text-white relative text-center">
                <p id="texto-ubicacion" class="text-sm font-bold leading-tight uppercase"></p>
                <button onclick="localStorage.removeItem('config_testigo'); location.reload();" class="text-[9px] text-blue-300 underline mt-2 uppercase font-black">Cambiar Mesa / Corregir</button>
            </div>

            <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-2 text-center">Votos Candidato en E-14</label>
                <input type="number" id="input-votos" autocomplete="off" class="w-full p-6 border-4 border-emerald-500 rounded-3xl text-center text-6xl font-black text-emerald-700 bg-emerald-50 outline-none shadow-inner" placeholder="0">
            </div>

            <div class="border-4 border-dashed border-slate-200 bg-slate-50 p-8 rounded-3xl text-center cursor-pointer hover:bg-slate-100 transition-all relative" onclick="document.getElementById('input-foto').click()">
                <div id="previo-foto" class="space-y-2">
                    <p class="text-4xl">üì∏ üìÅ</p>
                    <p class="text-blue-900 font-black text-xs uppercase tracking-tighter">Tomar o Subir Foto del E-14</p>
                    <p id="nombre-foto" class="text-[10px] text-slate-400 italic font-bold">Obligatorio para validar</p>
                </div>
                <input type="file" id="input-foto" accept="image/*" class="hidden">
            </div>

            <div class="bg-slate-100 p-4 rounded-2xl border border-slate-200">
                <label class="block text-[9px] font-black text-slate-500 uppercase mb-2 text-center">C√≥digo de Credencial Campa√±a</label>
                <input type="text" id="codigo-seguridad" autocomplete="off" class="w-full p-3 border-2 border-white rounded-xl text-center font-mono text-xl font-black uppercase outline-none focus:border-blue-500" placeholder="C√ìDIGO">
            </div>

            <button id="btn-enviar" disabled class="w-full bg-slate-300 text-white font-black py-5 rounded-2xl shadow-lg text-xl uppercase tracking-widest transition-all">
                Enviar Reporte
            </button>
        </div>

        <div id="pantalla-exito" class="hidden text-center py-10">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úì</div>
            <h2 class="text-2xl font-black text-blue-900 uppercase">¬°RECIBIDO!</h2>
            <p class="text-slate-500 text-xs mt-2">El dato pasar√° a validaci√≥n municipal.</p>
            <button onclick="nuevoReporte()" class="mt-8 bg-slate-200 px-8 py-3 rounded-xl font-black text-xs uppercase text-slate-600">Reportar otra mesa</button>
        </div>
    </div>

    <script>
        // C√ìDIGO SEGURO: Empieza vac√≠o, nadie lo puede ver en el c√≥digo fuente
        let CODIGO_MAESTRO = ""; 

        const sUrl = 'https://fybolbgnxoertkocmmza.supabase.co';
        const sKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5Ym9sYmdueG9lcnRrb2NtbXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTg4NzksImV4cCI6MjA4NzA3NDg3OX0.TtaObQZc_HnsG0qF7XZg7pkMo5_i1Sht_bcxrF8MoLE';
        const sClient = supabase.createClient(sUrl, sKey);

        // FUNCI√ìN NUEVA: Extrae la clave desde la base de datos de manera oculta
        async function cargarCodigoSeguridad() {
            try {
                const { data, error } = await sClient
                    .from('configuracion')
                    .select('codigo_testigos') // Aseg√∫rate de crear esta columna en Supabase
                    .eq('id', 1)
                    .single();
                
                if (data && !error) {
                    CODIGO_MAESTRO = data.codigo_testigos.toUpperCase();
                }
            } catch (err) {
                console.log("Esperando c√≥digo de seguridad...");
            }
        }
        cargarCodigoSeguridad(); // Llama a la base de datos ni bien abre la p√°gina

        const puestos = {
            "1": [ // ARAUCA
                { nombre: "COLEGIO SIMON BOLIVAR", mesas: 37 },
                { nombre: "CONCENTRACION CAMILO TORRES", mesas: 21 },
                { nombre: "ESCUELA LOS LIBERTADORES", mesas: 8 },
                { nombre: "ESCUELA JOSE MARIA CORDOBA", mesas: 5 },
                { nombre: "NORMAL MARIA INMACULADA", mesas: 26 },
                { nombre: "COLEGIO TEC. CRISTO REY", mesas: 40 },
                { nombre: "ESCUELA FLOR DE MI LLANO", mesas: 26 },
                { nombre: "UNIDAD DE SALUD MENTAL ARAUCA", mesas: 1 },
                { nombre: "IE JUAN ISIDRO DABOIN", mesas: 2 },
                { nombre: "IE SEDE LUIS CARLOS GALAN", mesas: 1 },
                { nombre: "COLEGIO SANTANDER PRIMARIA", mesas: 22 },
                { nombre: "CONC.ESCOLAR LAS COROCORAS", mesas: 13 },
                { nombre: "CONC.ESCOLAR DIVINO NI√ëO", mesas: 28 },
                { nombre: "COL TEC SANTA TERESITA", mesas: 13 },
                { nombre: "CARCEL", mesas: 1 },
                { nombre: "CA√ëAS BRAVAS", mesas: 2 },
                { nombre: "MAPORILLAL", mesas: 1 },
                { nombre: "SANTA BARBARA", mesas: 4 },
                { nombre: "CARACOL", mesas: 2 },
                { nombre: "TODOS LOS SANTOS", mesas: 3 },
                { nombre: "LAS NUBES", mesas: 2 },
                { nombre: "FELICIANO", mesas: 1 },
                { nombre: "CLARINETERO", mesas: 1 }
            ],
            "2": [ // ARAUQUITA
                { nombre: "IE LICEO DEL LLANO", mesas: 16 },
                { nombre: "IE LICEO DEL LLANO SEDE SIMON BOLIVAR", mesas: 17 },
                { nombre: "IE GABRIEL GARCIA MARQUEZ SEC PRIMARIA", mesas: 16 },
                { nombre: "IE GABRIEL GARCIA MARQUEZ SEC SECUNDARIA", mesas: 17 },
                { nombre: "AGUACHICA", mesas: 6 },
                { nombre: "LA ESMERALDA", mesas: 11 },
                { nombre: "LA PAZ", mesas: 4 },
                { nombre: "REINERA", mesas: 4 },
                { nombre: "LA PESQUERA", mesas: 5 },
                { nombre: "BRISAS DEL CARANAL", mesas: 2 },
                { nombre: "RESGUARDO INDIGENA EL VIGIA", mesas: 1 },
                { nombre: "RESGUARDO INDIGENA SAN JOSE DE LIPA", mesas: 1 },
                { nombre: "RESGUARDO INDIGENA IGUANITOS", mesas: 1 },
                { nombre: "VEREDA FILIPINAS", mesas: 1 },
                { nombre: "VEREDA SAN LORENZO", mesas: 1 },
                { nombre: "VEREDA EL TRONCAL", mesas: 2 },
                { nombre: "PANAMA DE ARAUCA", mesas: 10 }
            ],
            "3": [ // CRAVO NORTE
                { nombre: "PUESTO CABECERA MUNICIPAL", mesas: 12 }
            ],
            "4": [ // FORTUL
                { nombre: "POLIDEPORTIVO MUNICIPAL", mesas: 18 },
                { nombre: "CONCENTRACION ALEJANDRO HUMBOLDT", mesas: 15 },
                { nombre: "CA√ëO FLOREZ", mesas: 3 },
                { nombre: "NUEVO CARANAL", mesas: 6 },
                { nombre: "MATECA√ëA", mesas: 2 }
            ],
            "5": [ // PUERTO ROND√ìN
                { nombre: "PUESTO CABECERA MUNICIPAL", mesas: 13 }
            ],
            "6": [ // SARAVENA
                { nombre: "CENTRO CULT Y DEPORTIVO SIMON", mesas: 19 },
                { nombre: "IE LA FRONTERA", mesas: 27 },
                { nombre: "SEDE EDUCATIVA SEIS DE OCTUBRE", mesas: 19 },
                { nombre: "SEDE EDUCATIVA LAS VILLAS", mesas: 8 },
                { nombre: "SEDE EDUCATIVA GENERAL SANTANDER", mesas: 14 },
                { nombre: "IE TEC.IND.RAFAEL POMBO BTO", mesas: 25 },
                { nombre: "SEDE EDUCATIVA MANUELA BELTRAN", mesas: 2 },
                { nombre: "PUERTO NARI√ëO", mesas: 10 },
                { nombre: "RESGUARDO INDIGENAS DE PLAYAS DE BOJABA", mesas: 1 },
                { nombre: "VEREDA VIAS", mesas: 3 }
            ],
            "7": [ // TAME
                { nombre: "COL. INST. ORIENTAL FEMENINO", mesas: 21 },
                { nombre: "ESCUELA SAN ANTONIO", mesas: 22 },
                { nombre: "COLISEO CUBIERTO LOS LIBERTADORES", mesas: 13 },
                { nombre: "COLEGIO FROILAN FARIAS", mesas: 19 },
                { nombre: "CIUDADELA UNIVERSITARIA", mesas: 14 },
                { nombre: "IE SAN LUIS", mesas: 1 },
                { nombre: "BETOYES", mesas: 5 },
                { nombre: "PUERTO GAITAN", mesas: 1 },
                { nombre: "PUERTO SAN SALVADOR", mesas: 1 },
                { nombre: "LA HOLANDA", mesas: 1 },
                { nombre: "LA ARENOSA", mesas: 2 },
                { nombre: "LAS MALVINAS", mesas: 2 },
                { nombre: "PUERTO JORDAN", mesas: 10 },
                { nombre: "CACHAMA", mesas: 1 },
                { nombre: "EL BOTALON", mesas: 7 },
                { nombre: "EL TABLON", mesas: 2 },
                { nombre: "CENTRO POBLADO  COROCITO", mesas: 4 },
                { nombre: "SANTO DOMINGO", mesas: 1 }
            ]
        };

        let blobComprimido = null;

        async function comprimirImagen(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.6);
                    };
                };
            });
        }

        const selMun = document.getElementById('select-municipio');
        const selPue = document.getElementById('select-puesto');
        const inputVotos = document.getElementById('input-votos');
        const inputCod = document.getElementById('codigo-seguridad');
        const btnEnv = document.getElementById('btn-enviar');

        selMun.addEventListener('change', () => {
            selPue.innerHTML = '<option value="">Seleccione Puesto</option>';
            if(selMun.value) {
                puestos[selMun.value].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.nombre;
                    opt.textContent = `${p.nombre} (M√°x: ${p.mesas})`;
                    opt.dataset.maxMesas = p.mesas;
                    selPue.appendChild(opt);
                });
                selPue.disabled = false;
            } else {
                selPue.disabled = true;
            }
        });

        document.getElementById('btn-fijar').addEventListener('click', async () => {
            const mesaInput = document.getElementById('input-mesa').value;
            const mesa = parseInt(mesaInput);
            const munId = selMun.value;
            const puesto = selPue.value;

            if(!munId || !puesto || !mesaInput) return alert("Por favor, completa todos los campos.");

            const opcionSeleccionada = selPue.options[selPue.selectedIndex];
            const maxMesas = parseInt(opcionSeleccionada.dataset.maxMesas);

            if (mesa < 1 || mesa > maxMesas) {
                return alert(`‚ö†Ô∏è ERROR: El puesto ${puesto} solo tiene ${maxMesas} mesas. Verifique el n√∫mero de su mesa.`);
            }

            const btnFijar = document.getElementById('btn-fijar');
            btnFijar.innerText = "üîç VERIFICANDO MESA...";
            btnFijar.disabled = true;

            try {
                const { data, error } = await sClient
                    .from('reportes')
                    .select('id')
                    .eq('municipio_id', parseInt(munId))
                    .eq('puesto_nombre', puesto)
                    .eq('mesa_numero', mesa)
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    alert("‚ö†Ô∏è La Mesa " + mesa + " ya fue reportada anteriormente. Verifique si ya envi√≥ el dato.");
                    btnFijar.innerText = "Fijar Ubicaci√≥n";
                    btnFijar.disabled = false;
                } else {
                    localStorage.setItem('config_testigo', JSON.stringify({ 
                        munId: munId, munNom: selMun.options[selMun.selectedIndex].text, pue: puesto, mesa: mesa 
                    }));
                    render();
                }
            } catch (err) {
                alert("Error al verificar base de datos.");
                btnFijar.innerText = "Fijar Ubicaci√≥n";
                btnFijar.disabled = false;
            }
        });

        function render() {
            const d = JSON.parse(localStorage.getItem('config_testigo'));
            if(d) {
                document.getElementById('pantalla-config').classList.add('hidden');
                document.getElementById('pantalla-reporte').classList.remove('hidden');
                document.getElementById('texto-ubicacion').innerText = `${d.munNom}\n${d.pue}\nMESA N¬∞ ${d.mesa}`;
            }
            if(localStorage.getItem('credencial_arauca')) {
                inputCod.value = localStorage.getItem('credencial_arauca');
                validarFormulario();
            }
        }

        function nuevoReporte() {
            localStorage.removeItem('config_testigo');
            location.reload();
        }

        document.getElementById('input-foto').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('previo-foto').innerHTML = `
                        <img src="${event.target.result}" class="max-h-32 mx-auto rounded-lg mb-2 shadow-md">
                        <p class="text-blue-900 font-black text-[10px] uppercase">Toca para cambiar foto</p>
                    `;
                };
                reader.readAsDataURL(e.target.files[0]);

                document.getElementById('nombre-foto').innerText = "‚è≥ OPTIMIZANDO...";
                blobComprimido = await comprimirImagen(e.target.files[0]);
                document.getElementById('nombre-foto').innerText = "‚úÖ LISTA PARA ENVIAR";
                validarFormulario();
            }
        });

        [inputCod, inputVotos].forEach(el => {
            el.addEventListener('input', validarFormulario);
            el.addEventListener('change', validarFormulario);
            el.addEventListener('blur', validarFormulario);
        });

        setInterval(validarFormulario, 1000);

        function validarFormulario() {
            // Protecci√≥n: Si el c√≥digo maestro a√∫n no ha cargado, no activa el bot√≥n
            if (CODIGO_MAESTRO === "") return;

            const codOk = inputCod.value.toUpperCase() === CODIGO_MAESTRO;
            const votosOk = inputVotos.value.length > 0;
            const fotoOk = blobComprimido !== null;
            btnEnv.disabled = !(codOk && votosOk && fotoOk);
            btnEnv.className = btnEnv.disabled ? "w-full bg-slate-300 text-white font-black py-5 rounded-2xl shadow-lg text-xl uppercase tracking-widest transition-all" : "w-full bg-emerald-600 text-white font-black py-5 rounded-2xl shadow-lg text-xl uppercase tracking-widest hover:bg-emerald-700 transition-all";
            if(codOk) localStorage.setItem('credencial_arauca', inputCod.value.toUpperCase());
        }

        btnEnv.addEventListener('click', async () => {
            btnEnv.innerText = "‚è≥ SUBIENDO...";
            btnEnv.disabled = true;
            try {
                const conf = JSON.parse(localStorage.getItem('config_testigo'));
                const fileName = `E14_${Date.now()}.jpg`;
                const { error: errorFoto } = await sClient.storage.from('fotos_e14').upload(fileName, blobComprimido);
                if(errorFoto) throw errorFoto;
                const { data: publicUrl } = sClient.storage.from('fotos_e14').getPublicUrl(fileName);
                const { error: errorDb } = await sClient.from('reportes').insert([{
                    municipio_id: parseInt(conf.munId), puesto_nombre: conf.pue, mesa_numero: parseInt(conf.mesa),
                    votos_candidato: parseInt(inputVotos.value), foto_url: publicUrl.publicUrl, estado: 'pendiente'
                }]);
                if(errorDb) throw errorDb;
                document.getElementById('pantalla-reporte').classList.add('hidden');
                document.getElementById('pantalla-exito').classList.remove('hidden');
            } catch (err) {
                alert("Error al enviar el reporte. Revise su conexi√≥n.");
                btnEnv.innerText = "Enviar Reporte";
                btnEnv.disabled = false;
            }
        });

        render();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación de Validación Segura - Arauca 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="pantalla-login" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-t-8 border-blue-600">
            <div class="mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">Acceso Municipal</h2>
                <p class="text-slate-400 text-[10px] font-black uppercase mt-1 tracking-widest">Estación de Validación Oficial</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-left text-[10px] font-black text-slate-400 uppercase mb-1 ml-2">Seleccione Municipio</label>
                    <select id="select-inicio" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-blue-500 transition-all">
                        <option value="">-- Municipio --</option>
                        <option value="1">ARAUCA</option>
                        <option value="2">ARAUQUITA</option>
                        <option value="3">CRAVO NORTE</option>
                        <option value="4">FORTUL</option>
                        <option value="5">PUERTO RONDÓN</option>
                        <option value="6">SARAVENA</option>
                        <option value="7">TAME</option>
                    </select>
                </div>

                <div>
                    <label class="block text-left text-[10px] font-black text-slate-400 uppercase mb-1 ml-2">Contraseña Municipal</label>
                    <input type="password" id="pass-inicio" placeholder="••••••••" autocomplete="off" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-blue-500 transition-all text-center tracking-widest">
                </div>

                <button id="btn-login" onclick="iniciarSesionSegura()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest text-sm">
                    Ingresar a Estación
                </button>
            </div>
        </div>
    </div>

    <div id="interfaz-trabajo" class="hidden">
        <nav class="bg-white border-b border-slate-200 p-4 sticky top-0 z-40 shadow-sm flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <span class="bg-blue-900 text-white text-[10px] font-black px-2 py-1 rounded tracking-tighter uppercase">Validador</span>
                <h1 id="titulo-municipio" class="text-xl font-black text-blue-900 uppercase tracking-tighter"></h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="cambiarClaveMunicipal()" class="text-[10px] font-black text-slate-500 hover:text-blue-600 uppercase border-b border-transparent hover:border-blue-600 transition-all">
                    ⚙️ Cambiar Mi Clave
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sincronización en vivo</span>
                </div>
                <button onclick="cerrarSesion()" class="text-[10px] font-black text-red-500 border border-red-100 px-3 py-1 rounded-lg hover:bg-red-50 uppercase">Salir</button>
            </div>
        </nav>

        <div class="p-6 max-w-5xl mx-auto">
            <div id="contenedor-reportes" class="space-y-8"></div>
        </div>
    </div>

    <script>
        const sUrl = 'https://fybolbgnxoertkocmmza.supabase.co';
        const sKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5Ym9sYmdueG9lcnRrb2NtbXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTg4NzksImV4cCI6MjA4NzA3NDg3OX0.TtaObQZc_HnsG0qF7XZg7pkMo5_i1Sht_bcxrF8MoLE';
        const sClient = supabase.createClient(sUrl, sKey);

        let municipioActual = null;
        let nombreMunActual = "";
        let timer = null;

        const nombres = { 1: "Arauca", 2: "Arauquita", 3: "Cravo Norte", 4: "Fortul", 5: "Puerto Rondón", 6: "Saravena", 7: "Tame" };

        async function iniciarSesionSegura() {
            const idMun = document.getElementById('select-inicio').value;
            const passIngresada = document.getElementById('pass-inicio').value;
            const btn = document.getElementById('btn-login');

            if (!idMun || !passIngresada) return alert("Complete los datos");

            btn.innerText = "Verificando...";
            btn.disabled = true;

            try {
                // Consultamos la clave de ese municipio específico
                const { data, error } = await sClient
                    .from('llaves_municipales')
                    .select('clave')
                    .eq('municipio_id', idMun)
                    .single();

                if (error) throw error;

                if (data && data.clave === passIngresada) {
                    municipioActual = idMun;
                    nombreMunActual = nombres[idMun];
                    
                    document.getElementById('titulo-municipio').innerText = nombreMunActual;
                    document.getElementById('pantalla-login').classList.add('hidden');
                    document.getElementById('interfaz-trabajo').classList.remove('hidden');
                    
                    cargarDatos();
                    timer = setInterval(cargarDatos, 3000);
                } else {
                    alert("⚠️ Contraseña incorrecta para este municipio");
                    document.getElementById('pass-inicio').value = "";
                    btn.innerText = "Ingresar a Estación";
                    btn.disabled = false;
                }
            } catch (err) {
                alert("Error de conexión con la base de datos.");
                btn.innerText = "Ingresar a Estación";
                btn.disabled = false;
            }
        }

        async function cambiarClaveMunicipal() {
            const nueva = prompt(`Nueva clave para ${nombreMunActual}:`);
            if (!nueva || nueva.length < 4) return alert("Mínimo 4 caracteres.");

            const { error } = await sClient
                .from('llaves_municipales')
                .update({ clave: nueva })
                .eq('municipio_id', municipioActual);

            if (!error) alert("✅ Clave municipal actualizada.");
            else alert("Error al actualizar.");
        }

        function cerrarSesion() {
            clearInterval(timer);
            location.reload();
        }

        async function cargarDatos() {
            const { data, error } = await sClient
                .from('reportes')
                .select('*')
                .eq('municipio_id', municipioActual)
                .eq('estado', 'pendiente')
                .order('creado_en', { ascending: true });

            const container = document.getElementById('contenedor-reportes');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20 bg-white rounded-3xl border-2 border-dashed border-slate-300">
                        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Esperando reportes de ${nombreMunActual}...</p>
                    </div>`;
                return;
            }

            if (document.activeElement.tagName === 'INPUT') return;

            container.innerHTML = '';
            data.forEach(r => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row border-l-[12px] border-blue-600 animate-in slide-in-from-right duration-500 mb-6";
                card.innerHTML = `
                    <div class="md:w-1/2 bg-slate-900 flex items-center justify-center p-2">
                        <img src="${r.foto_url}" class="max-h-[500px] rounded-lg shadow-2xl cursor-zoom-in" onclick="window.open('${r.foto_url}')">
                    </div>
                    <div class="md:w-1/2 p-8 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-blue-100 text-blue-700 px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Mesa ${r.mesa_numero}</span>
                                <span class="text-[10px] font-mono text-slate-400">${new Date(r.creado_en).toLocaleTimeString()}</span>
                            </div>
                            <h3 class="text-3xl font-black text-slate-800 leading-tight">${r.puesto_nombre}</h3>
                            <div class="mt-4 p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Reporte Testigo:</p>
                                <p class="text-3xl font-black text-slate-700">${r.votos_candidato} <span class="text-sm font-normal text-slate-400 uppercase">Votos</span></p>
                            </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <label class="block text-xs font-black text-slate-500 uppercase ml-1">Confirmar Dato Oficial:</label>
                            <input type="number" id="votos-${r.id}" value="${r.votos_candidato}" class="w-full border-4 border-emerald-500 p-5 rounded-2xl text-5xl font-black text-emerald-700 outline-none bg-emerald-50/30">
                            <div class="flex gap-3 pt-2">
                                <button onclick="procesar('${r.id}', 'aprobado')" class="flex-1 bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-lg hover:bg-emerald-600 transition-all uppercase text-xs tracking-widest">Validar ✅</button>
                                <button onclick="procesar('${r.id}', 'rechazado')" class="px-6 bg-red-50 text-red-500 font-bold py-5 rounded-2xl hover:bg-red-100 transition-all uppercase text-[9px]">Rechazar ❌</button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        async function procesar(id, estado) {
            const v = document.getElementById('votos-' + id).value;
            const { error } = await sClient.from('reportes').update({ estado: estado, votos_oficiales: parseInt(v) }).eq('id', id);
            if (!error) cargarDatos();
            else alert("Error al procesar.");
        }
    </script>
</body>
</html>

